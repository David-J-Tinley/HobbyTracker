name: HobbyTracker CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    name: Test on iPhone Simulator
    runs-on: macos-14 # Uses Apple Silicon runner (M1/M2) which is much faster
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      # Verify we are using the right Xcode version (Xcode 15.4 is standard on macos-14)
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.4.app

      # Install xcbeautify to make logs more readable
      - name: Install xcbeautify
	run: brew install xcbeautify

      # Run the tests
      - name: Run Tests
        run: |
          set -o pipefail && xcodebuild test \
            -project HobbyTracker.xcodeproj \
            -scheme HobbyTracker \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.5' \
            -testPlan HobbyTracker \
            clean test | xcbeautify
        # Note: We use 'set -o pipefail' so the build fails if xcodebuild fails,
        # even if the formatting tool (xcbeautify) succeeds.

      # (Optional) Upload Test Results if failure
      - name: Upload Test Results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: Test-Results
          path: |
            **/TestResults.xcresult
